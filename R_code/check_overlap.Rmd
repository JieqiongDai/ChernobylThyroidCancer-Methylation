---
title: "Report the overlap of the detected differntially methylated cpg islands by the two tools"
author: "Jieqiong Dai"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
      html_document:
        code_folding: hide
        toc: true
        toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Get the overlaped significant DMP generated by the two tools, p adjust <=0.01, fold change >=1.5
```{r,message=FALSE,warning=FALSE}
minfi1 <- read.csv("../minfi/phenotype_minfi_dmp_q0.01_annot.csv",header=T,row.names=1)
champ1 <- read.csv("../champ/phenotype_champ_dmp_q0.01.csv",header=T,row.names=1)
overlap1 <- champ1[rownames(champ1)%in%rownames(minfi1),]
overlap1 <- overlap1[order(overlap1 $ adj.P.Val,-abs(overlap1 $ logFC)),]
write.csv(overlap1,"../overlap/overlap_phenotype_dmp_q0.01.csv")
overlap11 <- subset(overlap1,logFC>=0.1760913|logFC<=-0.1760913)
nrow(overlap11)
write.csv(overlap11,"../overlap/overlap_phenotype_dmp_q0.01fc1.5.csv")
```

# Heatmap of the normalized beta value of top 100 overlapped significant DMPs
```{r,message=FALSE,warning=FALSE}
load("../champ/champ_data.Rdata")
library(ggplot2)
library(ggfortify)
library(pheatmap)
if (nrow(overlap11)==0)
{
  print("No overlaped significant (p adjust <=0.01 and fold change >=1.5) DMP was detected.")
  } else{
pheno <- pheno[rownames(pheno)%in%colnames(beta),,drop=F]
pheno <- pheno[order(rownames(pheno)),,drop=F]
sig_beta1 <- beta[c(rownames(beta)%in%rownames(overlap11)),]
colnames(sig_beta1)==rownames(pheno)
sig_beta1 <- as.matrix(sig_beta1)
write.csv(sig_beta1,"../overlap/overlap_phenotype_sig_dmp_q0.01fc1.5_beta_data.csv")
df <- as.data.frame(pheno[,1])
rownames(df) <- rownames(pheno)
colnames(df) <- c("phenotype")
top1 <- sig_beta1[c(1:min(nrow(sig_beta1),100)),]
pheatmap(top1,cluster_rows=T,show_rownames=F,show_colnames=F,cluster_cols=T, annotation_col=df,treeheight_row = 0,treeheight_col = 0)
pheatmap(top1,cluster_rows=T,show_rownames=F,show_colnames=F,cluster_cols=T, annotation_col=df,treeheight_row = 0,treeheight_col = 0)
  }
```

# PCA plot of all samples

The PCA plot shows the samples in the 2D plane spanned by their first two principal components. This type of plot is useful for visualizing the overall effect of experimental covariates and batch effects.
```{r,message=FALSE,warning=FALSE}
load("../data/inital_data.Rdata")
pca <- as.data.frame(t(beta))
pca <- cbind(pca,pheno[,1])
colnames(pca)[866092] <- "phenotype"
pca_data <- prcomp(pca[,1:866091])
autoplot(pca_data,data=pca,colour="phenotype")
library(plotly)
pca_df <- as.data.frame(pca_data $ x)[,1:2]
pca_df <- cbind(pca_df,pheno[,1])
colnames(pca_df)[3] <- "phenotype"
plot_ly(pca_df,x=~PC1,y=~PC2,text = rownames(pca_df),color=~phenotype)

save.image("../overlap/overlap.Rdata")
```
